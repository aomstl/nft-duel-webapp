<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Pomodoro Timer</title>
  <!-- –°–∫—Ä–∏–ø—Ç Telegram Mini Apps -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111827;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .container {
      text-align: center;
      padding: 24px;
      border-radius: 16px;
      background: #1f2937;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      width: 320px;
    }
    h1 {
      margin-top: 0;
      font-size: 20px;
      margin-bottom: 8px;
    }
    .subtitle {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 20px;
    }
    .timer {
      font-size: 48px;
      font-weight: 600;
      margin-bottom: 20px;
    }
    .buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 12px;
    }
    button {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-primary {
      background: #ef4444;
      color: white;
    }
    .btn-secondary {
      background: #374151;
      color: #e5e7eb;
    }
    .status {
      font-size: 12px;
      color: #9ca3af;
      min-height: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Pomodoro</h1>
    <div class="subtitle">25 –º–∏–Ω—É—Ç —Ñ–æ–∫—É—Å–∞, –ø–æ—Ç–æ–º –ø–µ—Ä–µ—Ä—ã–≤</div>

    <div class="timer" id="timerDisplay">25:00</div>

    <div class="buttons">
      <button class="btn-primary" id="startBtn">–°—Ç–∞—Ä—Ç</button>
      <button class="btn-secondary" id="pauseBtn">–ü–∞—É–∑–∞</button>
      <button class="btn-secondary" id="resetBtn">–°–±—Ä–æ—Å</button>
    </div>

    <div class="status" id="statusText"></div>
  </div>

  <script>
    const POMO_SECONDS = 25 * 60;
    let remaining = POMO_SECONDS;
    let intervalId = null;
    let isRunning = false;

    const timerDisplay = document.getElementById("timerDisplay");
    const startBtn = document.getElementById("startBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const resetBtn = document.getElementById("resetBtn");
    const statusText = document.getElementById("statusText");

    // habit_id –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä –≤ URL –∏–ª–∏ initData
    const urlParams = new URLSearchParams(window.location.search);
    const habitId = urlParams.get("habit_id") || null;

    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
    }

    function updateDisplay() {
      timerDisplay.textContent = formatTime(remaining);
    }

    function sendFinishToBot() {
      if (!window.Telegram || !window.Telegram.WebApp) return;
      const payload = {
        type: "pomodoro_finished",
        habit_id: habitId,
        duration_sec: POMO_SECONDS,
        finished_at: new Date().toISOString()
      };
      Telegram.WebApp.sendData(JSON.stringify(payload));
      Telegram.WebApp.close(); // —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –º–∏–Ω–∏‚Äë–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    }

    function tick() {
      if (!isRunning) return;
      if (remaining <= 0) {
        clearInterval(intervalId);
        intervalId = null;
        isRunning = false;
        statusText.textContent = "–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ üéâ";
        sendFinishToBot();
        return;
      }
      remaining -= 1;
      updateDisplay();
    }

    startBtn.addEventListener("click", () => {
      if (isRunning) return;
      isRunning = true;
      statusText.textContent = "–ò–¥—ë—Ç —Ñ–æ–∫—É—Å‚Äë—Å–µ—Å—Å–∏—è‚Ä¶";
      if (!intervalId) {
        intervalId = setInterval(tick, 1000);
      }
    });

    pauseBtn.addEventListener("click", () => {
      if (!isRunning) return;
      isRunning = false;
      statusText.textContent = "–ü–∞—É–∑–∞";
    });

    resetBtn.addEventListener("click", () => {
      isRunning = false;
      clearInterval(intervalId);
      intervalId = null;
      remaining = POMO_SECONDS;
      updateDisplay();
      statusText.textContent = "";
    });

    updateDisplay();
  </script>
</body>
</html>
